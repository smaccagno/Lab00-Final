<template>
    <lightning-card title="Lista dei Biglietti">
        <!-- █████████████  FILTRI  ▒▒▒  RIGA 1  ▒▒▒  █████████████ -->
        <lightning-layout>
            <!-- Anno -->
            <lightning-layout-item size="2" padding="around-small">
                <label class="custom-label">Anno</label>
                <lightning-combobox variant="label-hidden"
                                    value={selectedYear}
                                    options={yearOptions}
                                    onchange={handleYearChange}
                                    disabled={disableYearFilter}>
                </lightning-combobox>
            </lightning-layout-item>

            <!-- Mese -->
            <lightning-layout-item size="2" padding="around-small">
                <label class="custom-label">Mese</label>
                <lightning-combobox variant="label-hidden"
                                    value={selectedMonth}
                                    options={monthOptions}
                                    onchange={handleMonthChange}
                                    disabled={uiDisabled}>
                </lightning-combobox>
            </lightning-layout-item>

            <!-- Tipologia -->
            <lightning-layout-item size="2" padding="around-small">
                <label class="custom-label">Tipologia</label>
                <lightning-combobox variant="label-hidden"
                                    value={selectedType}
                                    options={typeOptions}
                                    onchange={handleTypeChange}
                                    disabled={uiDisabled}>
                </lightning-combobox>
            </lightning-layout-item>

            <!-- Numero Fattura -->
            <lightning-layout-item size="3" padding="around-small">
                <label class="custom-label">Numero Fattura</label>
                <lightning-input type="search" variant="label-hidden"
                                 value={invoiceNumberFilter}
                                 onchange={handleInvoiceNumberChange}
                                 placeholder="Cerca…"
                                 disabled={uiDisabled}>
                </lightning-input>
            </lightning-layout-item>

            <!-- Budget (se visibile) -->
            <template if:false={hideBudget}>
                <lightning-layout-item size="3" padding="around-small">
                    <label class="custom-label">Budget</label>
                    <lightning-combobox variant="label-hidden"
                                        value={selectedBudgetId}
                                        options={budgetOptions}
                                        onchange={handleBudgetChange}
                                        disabled={uiDisabled}>
                    </lightning-combobox>
                </lightning-layout-item>
            </template>
        </lightning-layout>

        <!-- █████████████  FILTRI  ▒▒▒  RIGA 2  ▒▒▒  █████████████ -->
        <lightning-layout class="slds-m-top_x-small">
            <!-- Comune -->
            <lightning-layout-item size="3" padding="around-small">
                <label class="custom-label">Comune</label>
                <lightning-button class="reset-button" variant="base"
                                  icon-name="utility:refresh" icon-position="left"
                                  label="Reset" onclick={resetCity}
                                  disabled={uiDisabled}>
                </lightning-button>
                <lightning-combobox variant="label-hidden"
                                    value={selectedCity}
                                    options={cityOptions}
                                    onchange={handleCityChange}
                                    disabled={uiDisabled}>
                </lightning-combobox>
            </lightning-layout-item>

            <!-- Provincia -->
            <lightning-layout-item size="3" padding="around-small">
                <label class="custom-label">Provincia</label>
                <lightning-button class="reset-button" variant="base"
                                  icon-name="utility:refresh" icon-position="left"
                                  label="Reset" onclick={resetProvince}
                                  disabled={uiDisabled}>
                </lightning-button>
                <lightning-combobox variant="label-hidden"
                                    value={selectedProvince}
                                    options={provinceOptions}
                                    onchange={handleProvinceChange}
                                    disabled={uiDisabled}>
                </lightning-combobox>
            </lightning-layout-item>

            <!-- Regione -->
            <lightning-layout-item size="3" padding="around-small">
                <label class="custom-label">Regione</label>
                <lightning-button class="reset-button" variant="base"
                                  icon-name="utility:refresh" icon-position="left"
                                  label="Reset" onclick={resetRegion}
                                  disabled={uiDisabled}>
                </lightning-button>
                <lightning-combobox variant="label-hidden"
                                    value={selectedRegion}
                                    options={regionOptions}
                                    onchange={handleRegionChange}
                                    disabled={uiDisabled}>
                </lightning-combobox>
            </lightning-layout-item>
        </lightning-layout>

        <!-- ██████████  EXPORT  ██████████ -->
        <template if:true={isExporting}>
            <div class="slds-align_absolute-center slds-p-bottom_small">
                <lightning-spinner size="small"
                                   alternative-text="Esportazione in corso">
                </lightning-spinner>
            </div>
        </template>
        <lightning-layout>
            <lightning-layout-item size="12" class="slds-p-top_small">
                <lightning-button label="Esporta lista completa in Excel"
                                  onclick={exportAllRecords}
                                  class="slds-m-right_small"
                                  disabled={uiDisabled}>
                </lightning-button>
                <lightning-button label="Esporta tutti i dati filtrati"
                                  onclick={exportFilteredRecords}
                                  disabled={uiDisabled}>
                </lightning-button>
            </lightning-layout-item>
        </lightning-layout>

        <!-- ██████████  SPINNER INIT  ██████████ -->
        <template if:true={isLoadingInit}>
            <div class="slds-align_absolute-center slds-p-vertical_medium">
                <lightning-spinner alternative-text="Caricamento…" size="medium">
                </lightning-spinner>
            </div>
        </template>
        <template if:true={noBudgetFound}>
        <p class="slds-text-color_error slds-p-around_medium">
            Nessun Budget è associato al tuo utente.<br/>
            Contatta l’amministratore per poter accedere alla lista dei biglietti.
        </p>
        </template>
        <!-- ██████████  TOTALI + TAB  ██████████ -->
        <template if:false={isLoadingInit}>
            <div class="slds-p-around_medium">
                <p><b>Totale Biglietti:</b> {totalTickets}</p>
                <p><b>Totale Importo:</b> {totalAmount} EUR</p>
            </div>

            <div class="table-container" style="max-height:600px;overflow:auto">
                <lightning-datatable key-field="Id"
                                     data={relatedData}
                                     columns={columns}
                                     hide-checkbox-column
                                     sorted-direction={sortDirection}
                                     sorted-by={sortedBy}
                                     onsort={onHandleSort}
                                     enable-infinite-loading
                                     onloadmore={handleLoadMore}
                                     is-loading={isLoadingMore}
                                     wrap-table-header="all">
                </lightning-datatable>
            </div>
        </template>
    </lightning-card>
</template>